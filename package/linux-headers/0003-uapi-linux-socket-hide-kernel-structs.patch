From 7b2c9a8c6481846f8c45d869c02 Mon Sep 17 00:00:00 2001
From: Codex <codex@example.com>
Date: Thu, 12 Dec 2024 00:45:00 +0000
Subject: [PATCH] uapi: linux/socket: stop redefining libc structs

The ancient 2.6.26 linux/socket.h unconditionally exposes definitions
for struct sockaddr, msghdr, cmsghdr, etc., unless it detects glibc.
Modern kernels only provide those to the kernel build; user space is
expected to get the canonical versions from the C library. With musl
that detection fails (since it is not glibc), so BusyBox ends up pulling
in duplicate struct definitions from both linux/socket.h and musl's
sys/socket.h, leading to redefinition errors.

Match the contemporary behaviour by restricting the kernel-only
includes, typedefs and struct definitions to `#ifdef __KERNEL__`. The
protocol/option macros remain visible to user space, but the actual
structs now come exclusively from the C library, eliminating the
conflicts while leaving the kernel ABI untouched.
---
 include/linux/socket.h | 8 ++++----
 1 file changed, 4 insertions(+), 4 deletions(-)

--- a/include/linux/socket.h
+++ b/include/linux/socket.h
@@ -16,7 +16,7 @@
 				/* _SS_MAXSIZE value minus size of ss_family */
 } __attribute__ ((aligned(_K_SS_ALIGNSIZE)));	/* force desired alignment */
 
-#if defined(__KERNEL__) || !defined(__GLIBC__) || (__GLIBC__ < 2)
+#ifdef __KERNEL__
 
 #include <asm/socket.h>			/* arch-dependent defines	*/
 #include <linux/sockios.h>		/* the SIOCxxx I/O controls	*/
@@ -155,6 +155,8 @@
 	__u32	gid;
 };
 
+#endif /* __KERNEL__ */
+
 /* Supported address families. */
 #define AF_UNSPEC	0
 #define AF_UNIX		1	/* Unix domain sockets 		*/
@@ -313,5 +315,4 @@
 extern int put_cmsg(struct msghdr*, int level, int type, int len, void *data);
 
 #endif
-#endif /* not kernel and not glibc */
 #endif /* _LINUX_SOCKET_H */
